{% extends "admin/index.html" %}
{% load i18n admin_urls static admin_modify %}


{% block recent_actions  %}
	{% if request.user.is_superuser %}

		<script type="text/javascript" src="{% static "dygraphs/dygraph-combined.js" %} "></script>
		<script type="text/javascript" src="{% static "chosen/chosen.jquery.js" %} "></script>
  		<link rel="stylesheet" type="text/css" href="{% static "chosen/chosen.css" %}" />

		<style type="text/css">
			.few .dygraph-legend > span.highlight { border: 1px solid grey; }

			.many .dygraph-legend > span { display: none; }

			.many .dygraph-legend > span.highlight { display: inline; }
		</style>
		<select id="placas" class="chosen-select" data-placeholder="Escolha os Equipamentos ..." style="width:350px;" multiple="" tabindex="2">
      	</select>
      	<select id="date" class="chosen-select" data-placeholder="Meses atrás..." style="width:350px;" tabindex="3">
      		<option value="1">1 Mês</option>
      		<option value="2">2 Mês</option>
      		<option value="3">3 Mês</option>
      		<option value="4">4 Mês</option>
      		<option value="6">6 Mês</option>
      		<option value="12" selected="">12 Mês/ 1 Ano</option>
      	</select>
		<div id="demo"></div>
		<select id="placas-favoritas" class="chosen-select" data-placeholder="Escolha os Equipamentos Favoritos..." style="width:350px;" multiple="" tabindex="4">
      	</select>
		<div id="favoritos_graficos"></div>

		<script type="text/javascript">
		   $(document).ready(function () {
		   		var change_mainGraph = function(evt, params) {
				    console.log("Changed")
				    var selected_values  = $("#placas").chosen().val();
				    var monthsago_selected  = $("#date").chosen().val();
				    selected_values = selected_values?selected_values:[];
				    var string_selected_values =  selected_values.join(",");
				    generateGraph(string_selected_values,'demo',monthsago_selected);
			  	};
		   		var generateGraph = function(placas,div_initial,monthsago){
		   			var div_initial = div_initial? div_initial:'demo';
		   			var monthsago_val = monthsago?monthsago:12
		   			var placas_query = placas?'placas='+placas+'&' :''
		   			var monthsago_query = monthsago_val?'monthsago='+monthsago_val+'&':''
		   			var query =  placas_query+monthsago_query
		   			$.getJSON( "/customgraph?"+query, function( data ) {
	   					$('#'+div_initial).empty()
						makeGraph(div_initial,"few", 1, 10, false,data);
						makeGraph(div_initial,"few", 1, 10, true,data);
						makeGraph(div_initial,"many",1, 10, false,data);
						makeGraph(div_initial,"many",1, 10, true,data);
					});
		   		};

				var makeGraph = function(div_name,className, numSeries, numRows, isStacked,data) {
					var demo = document.getElementById(div_name);
					var div = document.createElement('div');
					div.className = className;
					div.style.display = 'inline-block';
					div.style.margin = '4px';
					demo.appendChild(div);

					var labels = ['Date'];
					if (data){
						for (var i = 0; i < data.labels.length; ++i) {
					    var label = '' + data.labels[i];
					    labels[i + 1] = label;
					  }
					}else{

					  for (var i = 0; i < numSeries; ++i) {
					    var label = '' + i;
					    label = 's' + '000'.substr(label.length) + label;
					    labels[i + 1] = label;
					  }
					}
					var dataSource = []
					if (data){
					dataSource = data.data.map(function(a){var newArray = [new Date(a[0])]; return newArray.concat(a.slice(1)); })
					}else{
						dataSource = getData(numSeries, numRows, isStacked)
					}
				  	var g = new Dygraph(
				      div,
				      dataSource,
				      {
				        width: 480,
				        height: 320,
				        labels: labels.slice(),
				        stackedGraph: isStacked,

				        highlightCircleSize: 2,
				        strokeWidth: 1,
				        strokeBorderWidth: isStacked ? null : 1,
				        errorBars: false ,
				        axes: {
				        	x: {
					          axisLabelFormatter: function(d, gran) {
									var dd = d.getDate();
									var mm =  d.getMonth()+1; //January is 0!
									var yyyy =  d.getFullYear().toString().substr(2,2);
									if(dd<10){
									    dd='0'+dd
									} 
									if(mm<10){
									    mm='0'+mm
									} 
									var today = dd+'/'+mm+'/'+ yyyy;
					              return today;
					          },
					          valueFormatter: function(d, gran,a,b,c) {
					          		var date = new Date(d);
									var dd = date.getDate();
									var mm =  date.getMonth()+1; //January is 0!
									var yyyy =  date.getFullYear();
									if(dd<10){
									    dd='0'+dd
									} 
									if(mm<10){
									    mm='0'+mm
									} 
									var today = dd+'/'+mm+'/'+ yyyy;
					              return today;
					          }
					        },
				            y: {
				                axisLabelFormatter: function (y,vv,a,b,c) {
				                    return y+ 'Km';
				                },
				                valueFormatter: function (y,vv,a,b,index) {
				                	var today = new Date(b.lastx_)
				                	var dd = today.getDate();
									var mm = today.getMonth()+1; //January is 0!
									var yyyy = today.getFullYear();
									if(dd<10){
									    dd='0'+dd
									} 
									if(mm<10){
									    mm='0'+mm
									} 
									var today = yyyy+'/'+mm+'/'+dd;
				                	if (data && data.litros){
				                    	return y+ 'Km - litros: '+data.litros[a][today];
				                	}else{
				                    	return y+ 'Km - litros:'+index;
				                    }
				                }               
				            }
				        },
				        highlightSeriesOpts: {
				          strokeWidth: 3,
				          strokeBorderWidth: 1,
				          highlightCircleSize: 5
				        }
			      	});
				  	var onclick = function(ev) {
					    if (g.isSeriesLocked()) {
					      g.clearSelection();
					    } else {
					      g.setSelection(g.getSelection(), g.getHighlightSeries(), true);
					    }
				  	};
					g.updateOptions({clickCallback: onclick}, true);
					g.setSelection(false, 's005');
					//console.log(g);
				};

				$.getJSON( "/labels_available", function( data ) {
		   			selectId = document.getElementById('placas');
		   			initial_index = selectId.options.length
					for(i = 0;i<data.length;i++) {   			
 						selectId.options[initial_index] = new Option(data[i], data[i]);
 						initial_index++;
	 				}
	 				$("#placas.chosen-select").chosen({
						disable_search_threshold: 10,
						no_results_text: "Oops, Nada Encontrado!",
						width: "95%"
					});
				  	$("#date.chosen-select").chosen({
						disable_search_threshold: 10,
						no_results_text: "Oops, Nada Encontrado!",
						width: "95%"
					});
					$('#placas').on('change',change_mainGraph );
					$('#date').on('change', change_mainGraph);

				  	$.getJSON( "/labels_favorites", function( dataFavorite ) {
			   			selectId = document.getElementById('placas-favoritas');
			   			initial_index = selectId.options.length
						for(i = 0;i<data.length;i++) {   			
	 						selectId.options[initial_index] = new Option(data[i], data[i]);
	 						initial_index++;
		 				}
		 				for(i = 0;i<dataFavorite.length;i++) {   
		 					$('#placas-favoritas option[value="'+dataFavorite[i]+'"]').prop('selected', true);			
		 				}
		 				$("#placas-favoritas.chosen-select").chosen({
							disable_search_threshold: 10,
							no_results_text: "Oops, Nada Encontrado!",
							width: "95%"
						});
						$('#placas-favoritas').on('change', function(evt, params) {
						    console.log("Changed");
						    var selected_values  = $("#placas-favoritas.chosen-select").chosen().val();
				    		selected_values = selected_values?selected_values:[];
				    		var monthsago_selected  = $("#date").chosen().val();
						    var string_selected_values =  selected_values.join(",");

		   					$.getJSON( "/update_labels_favorites?placas="+string_selected_values, function( data ) {});
							generateGraph(string_selected_values,'favoritos_graficos',monthsago_selected);


					  	});
					  	var selected_values  = $("#placas-favoritas.chosen-select").chosen().val();
			    		selected_values = selected_values?selected_values:[];
			    		var monthsago_selected  = $("#date").chosen().val();
					    var string_selected_values =  selected_values.join(",");
						generateGraph(string_selected_values,'favoritos_graficos',monthsago_selected);

					});
					generateGraph();

				});
				
				
		    });
		</script>

		<iframe src="https://jpgraficos.herokuapp.com/caravel/explore/table/1/?x_axis_label=&datasource_name=abastecimento_abastecimento&goto_dash=false&contribution=false&slice_name=Soma+do+Consumo+de+Combust%C3%ADveis+pelo+tempo&show_legend=y&resample_how=&num_period_compare=&since=1+year+ago&y_axis_label=&x_axis_showminmax=y&y_axis_zero=false&flt_op_0=in&viz_type=line&add_to_dash=existing&datasource_type=table&rolling_periods=&time_compare=&userid=1&flt_col_0=combustivel&slice_id=8&x_axis_format=smart_date&show_brush=y&until=now&new_slice_name=&save_to_dashboard_id=1&groupby=combustivel&new_dashboard_name=&flt_eq_0=&rich_tooltip=y&rolling_type=None&rdo_save=overwrite&resample_rule=&y_axis_format=.3s&where=&limit=50&having=&metrics=sum__quantidade&line_interpolation=linear&datasource_id=1&y_log_scale=false&standalone=true&resample_fillmethod=&collapsed_fieldsets=&granularity_sqla=criado_date" width="100%" height="800" seamless frameBorder="0" scrolling="no"></iframe>


		<iframe src="https://jpgraficos.herokuapp.com/caravel/explore/table/1/?donut=y&datasource_name=abastecimento_abastecimento&goto_dash=false&viz_type=pie&show_legend=y&slice_id=9&since=1+year+ago&flt_op_0=in&flt_op_1=in&add_to_dash=existing&datasource_type=table&userid=1&flt_col_0=combustivel&flt_col_1=combustivel&until=now&new_slice_name=Litros+de+Combustivel+-+Rosca&save_to_dashboard_id=1&groupby=combustivel&new_dashboard_name=&flt_eq_1=&flt_eq_0=&slice_name=Litros+de+Combustivel+-+Rosca&rdo_save=saveas&where=&limit=50&having=&metrics=sum__quantidade&datasource_id=1&standalone=true&collapsed_fieldsets=&granularity_sqla=criado_date" width="100%" height="800" seamless frameBorder="0" scrolling="no"></iframe>

	{% endif %}

 {{ block.super }}
{% endblock %}